// Firestore Security Rules
// Copy these to Firebase Console -> Firestore Database -> Rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isUser() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user';
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isActive() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isActive == true;
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Pages collection
    match /pages/{pageId} {
      // Read: Published pages by anyone, all pages by owner/admin
      allow read: if resource.data.isPublished == true || 
                     isOwner(resource.data.userId) || 
                     isAdmin();
      
      // Create: Authenticated users (status will be draft or pending)
      allow create: if isAuthenticated() && 
                       isActive() &&
                       request.resource.data.userId == request.auth.uid &&
                       (request.resource.data.status == 'draft' || 
                        request.resource.data.status == 'pending_approval');
      
      // Update: Owner can update draft/pending pages, admin can update any
      allow update: if (isOwner(resource.data.userId) && 
                        resource.data.status != 'published') || 
                       isAdmin();
      
      // Delete: Owner or admin
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }
    
    // Templates collection
    match /templates/{templateId} {
      allow read: if true; // Public templates
      allow write: if isAdmin();
    }
    
    // Analytics collection
    match /analytics/{docId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow write: if isAdmin();
    }
    
    // Pending approvals collection
    match /pendingApprovals/{approvalId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAdmin();
    }
    
    // Audit logs collection
    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Only via Cloud Functions
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isOwner(resource.data.userId);
      allow write: if isAdmin();
      allow delete: if isOwner(resource.data.userId);
    }
  }
}

// Storage Security Rules
// Copy these to Firebase Console -> Storage -> Rules

rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isImageFile() {
      return request.resource.contentType.matches('image/.*');
    }
    
    function isValidSize() {
      return request.resource.size < 5 * 1024 * 1024; // 5MB
    }
    
    // User profile images
    match /users/{userId}/profile/{imageId} {
      allow read: if true;
      allow write: if isAuthenticated() && 
                      request.auth.uid == userId &&
                      isImageFile() &&
                      isValidSize();
    }
    
    // Page images
    match /pages/{userId}/{pageId}/{imageId} {
      allow read: if true;
      allow write: if isAuthenticated() && 
                      request.auth.uid == userId &&
                      isImageFile() &&
                      isValidSize();
    }
    
    // Template images (admin only)
    match /templates/{templateId}/{imageId} {
      allow read: if true;
      allow write: if isAuthenticated(); // Check admin in app
    }
  }
}

// Realtime Database Security Rules
// Copy these to Firebase Console -> Realtime Database -> Rules

{
  "rules": {
    "presence": {
      "$userId": {
        ".read": "auth != null",
        ".write": "auth != null && auth.uid == $userId"
      }
    },
    "pageViews": {
      "$pageId": {
        ".read": true,
        ".write": true
      }
    },
    "onlineUsers": {
      ".read": "auth != null",
      "$userId": {
        ".write": "auth != null && auth.uid == $userId"
      }
    }
  }
}
